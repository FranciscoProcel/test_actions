#Variables necesarias
# WEBHOOK_ENABLED: 'true'  # Habilita o deshabilita el webhook
# ODOO_WEBHOOK_URL: URL del endpoint de la API de Odoo
# ODOO_WEBHOOK_TOKEN: Token de autorización para la API de Odoo (guardarlo en Secrets)
# MAIN_BRANCH: Nombre de la rama principal (16,18, etc.)

name: Deploy Info on PR Merge

on:
  pull_request:
    types: [closed]

permissions:
  pull-requests: read
  contents: read

jobs:
  notify_api:
    # Condiciones: 
      #1. El PR debe estar mergeado
      #2. La variable de entorno WEBHOOK_ENABLED debe estar en 'true'
      #3. La rama base del PR debe ser la rama principal (main o master)
    if: >
      github.event.pull_request.merged == true && 
      vars.WEBHOOK_ENABLED == 'true' &&
      contains(
        format(',{0},', vars.ALLOWED_BASE_BRANCHES), 
        format(',{0},', github.event.pull_request.base.ref)
      )
    
    runs-on: ubuntu-latest

    env:
      ODOO_WEBHOOK_URL: ${{ vars.ODOO_WEBHOOK_URL }}
      ODOO_WEBHOOK_TOKEN: ${{ secrets.ODOO_WEBHOOK_TOKEN }}
    
    steps:
      #//////////////////////// Obtiene los aprobadores del PR /////////////////
      # Usamos la API de GitHub para obtener los reviews del PR y filtrar los aprobadores
      - name: Get PR approvers
        id: approvers
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          API="https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews?per_page=100"
          REVIEWS="$(curl -sS --fail-with-body \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "$API")"

          APPROVERS="$(echo "$REVIEWS" | jq -c '
            sort_by([.user.login, .submitted_at])
            | group_by(.user.login)
            | map(.[-1])
            | map(select(.state=="APPROVED") | .user.login)
            | unique
          ')"

          if [ -z "$APPROVERS" ] || [ "$APPROVERS" = "null" ]; then
            APPROVERS="[]"
          fi

          echo "approvers=$APPROVERS" >> "$GITHUB_OUTPUT"
          echo "approvals_count=$(echo "$APPROVERS" | jq 'length')" >> "$GITHUB_OUTPUT"

      #/////////////////////// Construye el payload JSON //////////////////////
      - name: Build JSON payload
        run: |
          set -euo pipefail
          cat > payload.json <<'JSON'
          {
            "repository": "${{ github.repository }}",
            "repo_owner": "${{ github.repository_owner }}",
            "pr_number": ${{ github.event.pull_request.number }},
            "title": ${{ toJson(github.event.pull_request.title) }},
            "body": ${{ toJson(github.event.pull_request.body) }},
            "html_url": "${{ github.event.pull_request.html_url }}",
            "state": "${{ github.event.pull_request.state }}",
            "merged": ${{ github.event.pull_request.merged }},
            "merged_at": "${{ github.event.pull_request.merged_at }}",
            "merged_by": "${{ github.event.pull_request.merged_by.login }}",
            "base_branch": "${{ github.event.pull_request.base.ref }}",
            "head_branch": "${{ github.event.pull_request.head.ref }}",
            "merge_commit_sha": "${{ github.event.pull_request.merge_commit_sha }}",
            "labels": ${{ toJson(github.event.pull_request.labels.*.name) }},
            "assignees": ${{ toJson(github.event.pull_request.assignees.*.login) }},
            "requested_reviewers": ${{ toJson(github.event.pull_request.requested_reviewers.*.login) }},

            "approvers": ${{ steps.approvers.outputs.approvers }},
            "approvals_count": ${{ steps.approvers.outputs.approvals_count }}
          }
          JSON
          echo "Payload built"


      #////////////////////////// Envía el payload a tu API //////////////////////
      - name: Send data
        run: |
          set -euo pipefail

          curl -sS --fail-with-body -X PUT "$ODOO_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -H "Authorization: Bearer $ODOO_WEBHOOK_TOKEN" \
            --data-binary @payload.json \
            --max-time 20 \
            --retry 3 --retry-all-errors